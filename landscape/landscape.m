%landscape /moment equations
NN=200;
N=23;
% a=[0.382845870336397,1.59819467835539]; %
% S=[0,1.01967399380554,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.314977463267652,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,1.57624591338217,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.271204631268328,0.828811281518183,0,0,0.871048013232930,0.197337402950461,0,0,0.106874590335380,0,0,0.587645215125357,0,0.693727316111869,0.831744253197366,1.13165596133243,0.239471611161359,0,1.80436921738586,0;0,0,0,0,1.84935123109220,0,0,0.523110826283715,0,0,0,0,0,0,0.929693163688877,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,1.20837567905808,0,0,0,0.311080799138133,0,0,0,0,0,0,0,0,0,0,0,0.573281265014202,0,0,0;0,0,1.50845991466840,1.76993982696423,0.280058464027471,1.88468193943944,1.99120835384554,1.24882461644657,1.96296495394294,0,1.86902597833138,0,1.33289232810569,1.43566198756765,0.553071940951207,0,0,0,0,0.288797016890825,0,0.127141365666491,0;0,0,0,0,0,0,0,0,0,0.857606575344224,0,0,0,0,0,0,0,0,0,0,0,1.59676784279138,0;0,0,0,0.980569479641523,0,0,0,0.265871044330811,0,0,1.76684059546019,1.99570976683558,0,1.60430705212800,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,1.85409763613114,0,0,0,0,0.831598967993086,0,0.372623155305803,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0.350566041351230,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.70136693926330,0,0,0.927919916814974,0.403023729781034,0,0.0717627427033272,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.98776130981368,0,0,1.85264969777758,0,0,0.635562843846675,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.70535612398808,0,0,0;0,0,1.50559444030115,0,0,0,0,1.62035660274672,0,0.524243542943645,1.36132651780618,0,0,1.11535361665941,0,0,0,1.50474411664267,0,1.05936697913672,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.702232810358244,0,0,0,0,0,0,0,0,0,0.518522467326359,0,0,0,0,0,1.72494066076972,0,0.820701044062146,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.82869732931533,1.82414054934443,0,0.209642061374582,0,0,1.05686924286285,0,1.10810651766596,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.311846929469920;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.76870112810710;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.64848131816030,0,0,0];

% a=[0.287254426567009,1.42660489779454]; %
% S=[0,0.480600128985142,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.476707804705452,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0.533195472092184,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.213811485268515,1.01118295334783,0,0,0.236386023209154,1.70434469399084,0,0,0.431544513787331,0,0,1.52067663305045,0,0.800998334056692,1.50659316879585,1.18184257356575,0.438511123270178,0,1.54591857391671,0;0,0,0,0,1.26379578547558,0,0,1.18587822700899,0,0,0,0,0,0,1.13414894380245,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.465678046802833,0,0,0,1.98096828422210,0,0,0,0,0,0,0,0,0,0,0,1.38319427932907,0,0,0;0,0,1.06343559242418,0.574134081934623,1.58260728096401,1.64939703622354,0.106790309642025,0.917724149409198,0.0249874755584977,0,0.0500059303849345,0,1.72756137481615,0.625030351623183,1.99746139708714,0,0,0,0,0.672740289494445,0,0.934770290414470,0;0,0,0,0,0,0,0,0,0,0.0487432510655945,0,0,0,0,0,0,0,0,0,0,0,1.03296893293746,0;0,0,0,1.85047105607078,0,0,0,0.143991309224492,0,0,0.939748912080739,1.14273139490805,0,0.715268511694665,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.670308770524854,0,0,0,0,0.328213412757572,0,0.214261965754735,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0.313790784028051,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.352625746659408,0,0,1.11001202623105,1.15021580870783,0,0.410523840265848,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.59974051360455,0,0,1.53550076006527,0,0,1.77391686247622,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.921261655251571,0,0,0;0,0,1.05085482636357,0,0,0,0,1.82640420197019,0,1.86633250738605,1.35774133264916,0,0,1.45648590460509,0,0,0,1.41804963322121,0,0.260090522863318,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.838401945616655,0,0,0,0,0,0,0,0,0,1.73366769544226,0,0,0,0,0,1.08892602501703,0,0.463985955424134,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.58875582666921,1.99997573442712,0,0.601164583989852,0,0,1.17976547349806,0,0.945571544248588,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.118280334840322;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0274443142572988;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.953005147564439,0,0,0];

a=[0.337511189025118,1.71547257494506];  %四稳态
S=[0,0.480600205334567,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.476649368187831,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0.554371833543858,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.214050066866581,1.01150782043768,0,0,0.252641011423531,1.69975080864157,0,0,0.350423829802572,0,0,1.52040161693672,0,0.814096045953305,1.50624159053630,1.18054139453856,0.479822417546709,0,1.54849970683895,0;0,0,0,0,1.26392277161559,0,0,1.18428791741280,0,0,0,0,0,0,1.13406744919528,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.419584238527765,0,0,0,1.98096558142731,0,0,0,0,0,0,0,0,0,0,0,0.244053016954201,0,0,0;0,0,1.06514204169624,0.572841820442919,1.58348750975792,1.65039892153491,0.107160582410745,0.915435300555898,0.0249851643835273,0,0.0500111603035696,0,1.72825463447869,0.615469774694976,1.99729547393664,0,0,0,0,0.664343225526201,0,0.933465752624602,0;0,0,0,0,0,0,0,0,0,0.0487449014501367,0,0,0,0,0,0,0,0,0,0,0,1.02705249108881,0;0,0,0,1.85043137962998,0,0,0,0.163444200493577,0,0,0.940461834844422,1.14193139093449,0,0.670631183262661,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0.674895133098312,0,0,0,0,0.331029189759052,0,0.218858928925101,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0.313802289053661,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.353185627844549,0,0,1.11008486894588,1.14639185987039,0,0.410643931420508,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.60648141222713,0,0,1.53797314690595,0,0,1.77935795133810,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.920514406593979,0,0,0;0,0,1.04701348867071,0,0,0,0,1.84381352680896,0,1.86896670442684,1.35667450118034,0,0,1.44888258274463,0,0,0,1.41835258838623,0,0.259706270688201,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0.841941255633873,0,0,0,0,0,0,0,0,0,1.72430244852520,0,0,0,0,0,1.08431396247711,0,0.433907714317311,0;0,0,0,0,0,0,0,0,0,0,0,0,0,1.58652122407020,1.99977496395109,0,0.601122884759696,0,0,1.17832240893235,0,0.945563028894612,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.118281477607919;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0274443228968884;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.952579418671455,0,0,0];
load('matrix.mat');
load('ss4.mat');
load('vars.mat');
Mat=matrix;
% sides=sum(sum(Mat~=0));
% snozero=find(Mat~=0);
% sidre=zeros(2,2,sides);
% mac1  6    cd19   18
M=1;
% S(snozero(uuu))=S(snozero(uuu))*1.15;
T=5000;
h=0.05;
nstep=T/h;
XX=zeros(NN,N);
SX=zeros(N,N,NN);
AX=zeros(N,N,NN);
fX=zeros(N,N,NN);
for i=1:NN
x=NN*rand(N,1);
sigma=NN*rand(N);
ff1=zeros(N,1);
ff2=zeros(N);
X=zeros(nstep,N);
Sigma=zeros(N,N,nstep);
% 计算方程1的stable state
for j = 1:nstep
ff1=force(x,M,Mat,a(1),a(2),S);
   for ii=1:N
   x(ii)=x(ii)+h*ff1(ii);
   X(j,ii)=x(ii);
   end
if norm(ff1)<0.001
    break
end
end
% 判断stable state
for jj=1:4
    dis(jj)=norm(ss4(jj,:)-x');
end
[m,mu]=min(dis);
% %不同stable state对应不同的D
va=vars(:,4);
for j=1:nstep 
ff2=fforce1(x,sigma,Mat,a(1),a(2),S,va);
for ii=1:N
    for jj=1:N
        sigma(ii,jj)=sigma(ii,jj)+h*ff2(ii,jj);
        Sigma(ii,jj,j)=sigma(ii,jj);
        fX(ii,jj,j)=ff2(ii,jj);
    end
end
if norm(ff2,'fro')<0.001
    break
end
end
XX(i,:)=x';
SX(:,:,i)=sigma;
end
SS=[];
SS=XX(1,:);
siz2=size(XX);
s=[];
sss=1;
s(1)=sss;
un=1;
for i=2:siz2(1)
    siz=size(SS);
    d=[];
    for j=1:siz(1)
        d(j)= (sum((XX(i,:)-SS(j,:)).^2))^(0.5);
    end
    if d>0.1
            SS=[SS;XX(i,:)];
            s=[s;1];
            un=[un,i];
    else
            sn=s(d<1);
            s(d<1)=sn+1;
    end
end
SSnew=nor(SS);
[z1,z2]=meshgrid(0:0.01:1.2);
z3=s(1)/100.*gau(z1,SSnew(1,6),SX(6,6,un(1))).*gau(z2,SSnew(1,18),SX(18,18,un(1)))+s(2)/100.*gau(z1,SSnew(2,6),SX(6,6,un(2))).*gau(z2,SSnew(2,18),SX(18,18,un(2)))+s(3)/100.*gau(z1,SSnew(3,6),SX(6,6,un(3))).*gau(z2,SSnew(3,18),SX(18,18,un(3)))+s(4)/100.*gau(z1,SSnew(4,6),SX(6,6,un(4))).*gau(z2,SSnew(4,18),SX(18,18,un(4)));
% 
% z3=s(1)/100.*gau(z1,SSnew(1,8),SX(8,8,un(1))).*gau(z2,SSnew(1,19),SX(19,19,un(1)))+s(2)/100.*gau(z1,SSnew(2,8),SX(8,8,un(2))).*gau(z2,SSnew(2,19),SX(19,19,un(2)))+s(3)/100.*gau(z1,SSnew(3,8),SX(8,8,un(3))).*gau(z2,SSnew(3,19),SX(19,19,un(3)))+s(4)/100.*gau(z1,SSnew(4,8),SX(8,8,un(4))).*gau(z2,SSnew(4,19),SX(19,19,un(4)));

% % z3=s(1)/100.*gau(z1,SSnew(1,6),SX(6,6,un(1))).*gau(z2,SSnew(1,18),SX(18,18,un(1)))+s(2)/100.*gau(z1,SSnew(2,6),SX(6,6,un(2))).*gau(z2,SSnew(2,18),SX(18,18,un(2)));
% % z3=s(1)/100.*gau(z1,SSnew(1,19),SX(6,6,un(1))).*gau(z2,SSnew(1,1),SX(18,18,un(1)))+s(2)/100.*gau(z1,SSnew(2,19),SX(6,6,un(2))).*gau(z2,SSnew(2,1),SX(18,18,un(2)))+s(3)/100.*gau(z1,SSnew(3,19),SX(6,6,un(3))).*gau(z2,SSnew(3,1),SX(18,18,un(3)))+s(4)/100.*gau(z1,SSnew(4,19),SX(6,6,un(4))).*gau(z2,SSnew(4,1),SX(18,18,un(4)));
z3=min(-10*log(z3),100);
surf(z1,z2,z3)
shading interp
xlabel("mac1")
ylabel("Cd19")
zlabel("U")
% z1=-2:0.01:2;
% z2=-2:0.01:2;
% z3=0.03*gau(z1,SS(1,6),sigma(6,6,1))*gau(z2,SS(1,18),sigma(18,18,1))+0.74*gau(z1,SS(2,6),sigma(6,6,2))*gau(z2,SS(2,18),sigma(18,18,2))+0.19*gau(z1,SS(3,6),sigma(6,6,3))*gau(z2,SS(3,18),sigma(18,18,3))+0.04*gau(z1,SS(4,6),sigma(6,6,20))*gau(z2,SS(4,18),sigma(18,18,20));
% surf(z1,z2,z3)

% %path
% params={}; 
% params.N=100; %The number of points in the minimum action path. 
% params.TMax = 10; %The time range of the minimum action path. 
% %Larger values can be more accurate, but can also lead to instabilities. 
% params.Dimension = size(SS, 1); %The dimension of the system. 
% params.c = 1e10; %The remeshing parameter, c. Larger values give greater remeshing. 
% params.MaxIter = 300; %The number of optimization steps to run between remeshing steps. 
% params.K= 2; %The number of total remeshing steps to do; 
% params.Remesh = 1; %Turn the remesh on or off. If off, the algorithm will be default perform K*MaxIter itereations. 
% params.q = 3; %The q parameter from the original paconstraints can be set of the path as well. This is not done in our per. Is a measure of path smoothness. 
% params.ub = []; %If desired, manuscript. 
% params.lb = []; %As above, lower bounds can be set on the path as well. This is also not done at all in our manuscript. 
% params.PhiInit =[]; %The default intial path between two states is a straight line. This can be modified here. 
% %params.ObjGrad = Parameters.JacobianPresent;%We require a Jacobian in this implementation. 
% params.ObjGrad=0;
% M=100;
% Func=@(x)force(x,M,Mat,a(1),a(2),S);
% dFunc=@(x)fforce1(x,sigma,Mat,a(1),a(2),S);
% 
% feasi_n=2;
% ycell=cell(feasi_n,feasi_n);
% for i=1:feasi_n
%     for j=1:feasi_n
%         if i==j
%             action(i,j) = Inf;
%         else
%             Spot1 = i;
%             Spot2 = j;%initial and end point
%             params.init = SS(:, [Spot1,Spot2]);
%             [ActionVal, Path] = AMAM(params, Func, dFunc);
%             action(i,j) = ActionVal;
%             ycell(i,j) = {[SS(:,i) Path SS(:,j)]};
%         end
%         (i-1)*feasi_n+j
%     end
% end
% sidre(:,:,uuu)=action;
% end
